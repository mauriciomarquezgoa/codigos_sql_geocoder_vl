--pasar coordenadas a activos previos
--pasar identificador anterior a activo que transfiere coordenadas
--activo sobrante solicitar cod activo nuevo

---TRANSFIRIENDO COORDENADAS DE RELEVAMIENTO DE PLAZAS A ACTIVOS DE LUMINARIAS COORDENADAS ERRADAS

(SELECT * FROM calculos.luminarias_octubre2024 
WHERE direccion_nor ILIKE '%sol' and direccion_nor ILIKE '%plaza%'
ORDER BY id_identificador);
	
(SELECT a.* FROM 
calculos.luminarias_octubre2024 AS a,
base.plazas AS b
WHERE ST_INTERSECTS(a.geom,b.geom) and b.nombre = 'PLAZA PASEO DEL SOL'
ORDER BY a.id_identificador);

UPDATE calculos.luminarias_octubre2024 AS d SET
codigo_unico = null,
activo_eliminar = 0,
geocodificado = 'NO'
FROM
(SELECT a.id_identificador FROM 
calculos.luminarias_octubre2024 AS a,
base.plazas AS b
WHERE ST_INTERSECTS(a.geom,b.geom) and b.nombre = 'PLAZA PASEO DEL SOL'
ORDER BY a.id_identificador) as e
WHERE d.id_identificador = e.id_identificador;

UPDATE calculos.luminarias_octubre2024 AS d SET
latitud_new = null,
longitud_new = null,
zona_new = null,
geom_new = null,
geom_line = null,
distancia = null,
direccion_new = null,
geocodificado = 'NO'
FROM
(SELECT * FROM calculos.luminarias_octubre2024 
WHERE direccion_nor ILIKE '%sol' and direccion_nor ILIKE '%plaza%'
ORDER BY descripcion DESC) as e
WHERE d.id_identificador = e.id_identificador;


DO
$do$
BEGIN 
   FOR i IN 1..(SELECT COUNT(*) FROM calculos.luminarias_octubre2024 WHERE direccion_nor ILIKE '%sol' and direccion_nor ILIKE '%plaza%') LOOP
			WITH 
			coordenadas_incorrectas as 
			(SELECT * FROM calculos.luminarias_octubre2024 
			WHERE direccion_nor ILIKE '%sol' AND geom_new is null and direccion_nor ILIKE '%plaza%'
			ORDER BY id_identificador), 
			coordenadas_correctas as 
			(SELECT a.* FROM 
			calculos.luminarias_octubre2024 AS a,
			base.plazas AS b
			WHERE ST_INTERSECTS(a.geom,b.geom) and b.nombre = 'PLAZA PASEO DEL SOL'
			ORDER BY a.id_identificador)
			UPDATE calculos.luminarias_octubre2024 SET
			latitud_new = 
			(SELECT 
			(ARRAY_AGG(latitud))[1]
			FROM coordenadas_correctas where activo_eliminar = 0),
			longitud_new = (SELECT 
			(ARRAY_AGG(longitud))[1]
			FROM coordenadas_correctas where activo_eliminar = 0),
			direccion_new = (SELECT 
			(ARRAY_AGG(direccion))[1]
			FROM coordenadas_correctas where activo_eliminar = 0),
			geocodificado = 'RELEVAMIENTO PLAZAS'
			
			WHERE 
			id_identificador = (SELECT 
			(ARRAY_AGG(id_identificador))[1] as id_identificador
			FROM coordenadas_incorrectas where geom_new is null);

			WITH 
			coordenadas_incorrectas as 
			(SELECT * FROM calculos.luminarias_octubre2024 
			WHERE direccion_nor ILIKE '%sol' AND geom_new is null and direccion_nor ILIKE '%plaza%'
			ORDER BY id_identificador), 
			coordenadas_correctas as 
			(SELECT a.* FROM 
			calculos.luminarias_octubre2024 AS a,
			base.plazas AS b
			WHERE ST_INTERSECTS(a.geom,b.geom) and b.nombre = 'PLAZA PASEO DEL SOL'
			ORDER BY a.id_identificador)
			UPDATE calculos.luminarias_octubre2024 SET
			codigo_unico = (SELECT (ARRAY_AGG(id_identificador))[1] as id_identificador
			FROM coordenadas_incorrectas where geom_new is null),
			activo_eliminar = 1
			WHERE 
			id_identificador = (SELECT 
			(ARRAY_AGG(id_identificador))[1] as id_identificador
			FROM coordenadas_correctas where activo_eliminar = 0);

			WITH 
			coordenadas_incorrectas as 
			(SELECT * FROM calculos.luminarias_octubre2024 
			WHERE direccion_nor ILIKE '%sol' AND geom_new is null and direccion_nor ILIKE '%plaza%'
			ORDER BY id_identificador), 
			coordenadas_correctas as 
			(SELECT a.* FROM 
			calculos.luminarias_octubre2024 AS a,
			base.plazas AS b
			WHERE ST_INTERSECTS(a.geom,b.geom) and b.nombre = 'PLAZA PASEO DEL SOL'
			ORDER BY a.id_identificador)
			UPDATE calculos.luminarias_octubre2024 SET
			geom_new = ST_TRANSFORM(ST_SETSRID(ST_MAKEPOINT((SELECT 
			(ARRAY_AGG(longitud))[1]
			FROM coordenadas_correctas where geocodificado = 'NO')::double precision,(SELECT 
			(ARRAY_AGG(latitud))[1]
			FROM coordenadas_correctas where geocodificado = 'NO')::double precision),4326),32721)
			WHERE 
			id_identificador = (SELECT 
			(ARRAY_AGG(id_identificador))[1] as id_identificador
			FROM coordenadas_incorrectas where geom_new is null);
			
			WITH 
			coordenadas_incorrectas as 
			(SELECT * FROM calculos.luminarias_octubre2024 
			WHERE direccion_nor ILIKE '%sol' AND geom_new is null and direccion_nor ILIKE '%plaza%'
			ORDER BY id_identificador), 
			coordenadas_correctas as 
			(SELECT a.* FROM 
			calculos.luminarias_octubre2024 AS a,
			base.plazas AS b
			WHERE ST_INTERSECTS(a.geom,b.geom) and b.nombre = 'PLAZA PASEO DEL SOL'
			ORDER BY a.id_identificador)
			UPDATE calculos.luminarias_octubre2024 SET
			geocodificado = 'A ELIMINAR'
			WHERE 
			id_identificador = (SELECT 
			(ARRAY_AGG(id_identificador))[1] as id_identificador
			FROM coordenadas_correctas where geocodificado = 'NO');
			
   END LOOP;
END
$do$;

---PLAZA CLARITA RUBIO

(SELECT * FROM calculos.luminarias_octubre2024 
WHERE 
direccion_nor ILIKE '%rubio' 
and direccion_nor ILIKE '%plaza%'
and left("descripcion",3) = 'COL'
ORDER BY id_identificador);

(SELECT a.* FROM 
calculos.luminarias_octubre2024 AS a,
base.plazas AS b
WHERE ST_INTERSECTS(a.geom,b.geom) and b.nombre = 'PLAZA CLARITA RUBIO'
AND descripcion = 'luminaria '
ORDER BY a.id_identificador);

UPDATE calculos.luminarias_octubre2024 AS d SET
codigo_unico = null,
activo_eliminar = 0,
geocodificado = 'NO'
FROM
(SELECT a.* FROM 
calculos.luminarias_octubre2024 AS a,
base.plazas AS b
WHERE ST_INTERSECTS(a.geom,b.geom) and b.nombre = 'PLAZA CLARITA RUBIO'
AND descripcion = 'luminaria '
ORDER BY a.id_identificador) as e
WHERE d.id_identificador = e.id_identificador;

UPDATE calculos.luminarias_octubre2024 AS d SET
latitud_new = null,
longitud_new = null,
zona_new = null,
geom_new = null,
geom_line = null,
distancia = null,
direccion_new = null,
geocodificado = 'NO'
FROM
(SELECT * FROM calculos.luminarias_octubre2024 
WHERE 
direccion_nor ILIKE '%rubio' 
--and geom_new is null 
and direccion_nor ILIKE '%plaza%'
and left("descripcion",3) = 'COL'
ORDER BY descripcion DESC) as e
WHERE d.id_identificador = e.id_identificador;

DO
$do$
BEGIN 
   FOR i IN 1..(SELECT COUNT(*) FROM calculos.luminarias_octubre2024 WHERE direccion_nor ILIKE '%rubio' and direccion_nor ILIKE '%plaza%' and left("descripcion",3) = 'COL') LOOP
			WITH 
			coordenadas_incorrectas as 
			(SELECT * FROM calculos.luminarias_octubre2024 
			WHERE 
			direccion_nor ILIKE '%rubio' and geom_new is null and direccion_nor ILIKE '%plaza%'
			and left("descripcion",3) = 'COL'
			ORDER BY id_identificador), 
			coordenadas_correctas as 
			(SELECT a.* FROM 
			calculos.luminarias_octubre2024 AS a,
			base.plazas AS b
			WHERE ST_INTERSECTS(a.geom,b.geom) and b.nombre = 'PLAZA CLARITA RUBIO'
			AND descripcion = 'luminaria '
			ORDER BY a.id_identificador)
			UPDATE calculos.luminarias_octubre2024 SET
			latitud_new = 
			(SELECT 
			(ARRAY_AGG(latitud))[1]
			FROM coordenadas_correctas where activo_eliminar = 0),
			longitud_new = (SELECT 
			(ARRAY_AGG(longitud))[1]
			FROM coordenadas_correctas where activo_eliminar = 0),
			direccion_new = (SELECT 
			(ARRAY_AGG(direccion))[1]
			FROM coordenadas_correctas where activo_eliminar = 0),
			geocodificado = 'RELEVAMIENTO PLAZAS'
		
			WHERE 
			id_identificador = (SELECT 
			(ARRAY_AGG(id_identificador))[1] as id_identificador
			FROM coordenadas_incorrectas where geom_new is null);

			WITH 
			coordenadas_incorrectas as 
			(SELECT * FROM calculos.luminarias_octubre2024 
			WHERE 
			direccion_nor ILIKE '%rubio' and geom_new is null and direccion_nor ILIKE '%plaza%'
			and left("descripcion",3) = 'COL'
			ORDER BY id_identificador), 
			coordenadas_correctas as 
			(SELECT a.* FROM 
			calculos.luminarias_octubre2024 AS a,
			base.plazas AS b
			WHERE ST_INTERSECTS(a.geom,b.geom) and b.nombre = 'PLAZA CLARITA RUBIO'
			AND descripcion = 'luminaria '
			ORDER BY a.id_identificador)
			UPDATE calculos.luminarias_octubre2024 SET
			codigo_unico = (SELECT (ARRAY_AGG(id_identificador))[1] as id_identificador
			FROM coordenadas_incorrectas where geom_new is null),
			activo_eliminar = 1
			WHERE 
			id_identificador = (SELECT 
			(ARRAY_AGG(id_identificador))[1] as id_identificador
			FROM coordenadas_correctas where activo_eliminar = 0);

			WITH 
			coordenadas_incorrectas as 
			(SELECT * FROM calculos.luminarias_octubre2024 
			WHERE 
			direccion_nor ILIKE '%rubio' and geom_new is null and direccion_nor ILIKE '%plaza%'
			and left("descripcion",3) = 'COL'
			ORDER BY id_identificador), 
			coordenadas_correctas as 
			(SELECT a.* FROM 
			calculos.luminarias_octubre2024 AS a,
			base.plazas AS b
			WHERE ST_INTERSECTS(a.geom,b.geom) and b.nombre = 'PLAZA CLARITA RUBIO'
			AND descripcion = 'luminaria '
			ORDER BY a.id_identificador)
			UPDATE calculos.luminarias_octubre2024 SET
			geom_new = ST_TRANSFORM(ST_SETSRID(ST_MAKEPOINT((SELECT 
			(ARRAY_AGG(longitud))[1]
			FROM coordenadas_correctas where geocodificado = 'NO')::double precision,(SELECT 
			(ARRAY_AGG(latitud))[1]																					 
			FROM coordenadas_correctas where geocodificado = 'NO')::double precision),4326),32721)
			WHERE 
			id_identificador = (SELECT 
			(ARRAY_AGG(id_identificador))[1] as id_identificador
			FROM coordenadas_incorrectas where geom_new is null);
			
			WITH 
			coordenadas_incorrectas as 
			(SELECT * FROM calculos.luminarias_octubre2024 
			WHERE 
			direccion_nor ILIKE '%rubio' and geom_new is null and direccion_nor ILIKE '%plaza%'
			and left("descripcion",3) = 'COL'
			ORDER BY id_identificador), 
			coordenadas_correctas as 
			(SELECT a.* FROM 
			calculos.luminarias_octubre2024 AS a,
			base.plazas AS b
			WHERE ST_INTERSECTS(a.geom,b.geom) and b.nombre = 'PLAZA CLARITA RUBIO'
			AND descripcion = 'luminaria '
			ORDER BY a.id_identificador)
			UPDATE calculos.luminarias_octubre2024 SET
			geocodificado = 'A ELIMINAR'
			WHERE 
			id_identificador = (SELECT 
			(ARRAY_AGG(id_identificador))[1] as id_identificador
			FROM coordenadas_correctas where geocodificado = 'NO');
   END LOOP;
END
$do$;

---PLAZA VERNET

(SELECT * FROM calculos.luminarias_octubre2024 
WHERE 
direccion_nor ILIKE '%vernet' 
and direccion_nor ILIKE '%plaza%'
and left("descripcion",3) = 'COL'
ORDER BY id_identificador);

(SELECT a.* FROM 
calculos.luminarias_octubre2024 AS a,
base.plazas AS b
WHERE ST_INTERSECTS(a.geom,b.geom) and b.nombre = 'PLAZA VERNET'
AND descripcion = 'luminaria '
ORDER BY a.id_identificador);

UPDATE calculos.luminarias_octubre2024 AS d SET
codigo_unico = null,
activo_eliminar = 0,
geocodificado = 'NO'
FROM
(SELECT a.* FROM 
calculos.luminarias_octubre2024 AS a,
base.plazas AS b
WHERE ST_INTERSECTS(a.geom,b.geom) and b.nombre = 'PLAZA VERNET'
AND descripcion = 'luminaria '
ORDER BY a.id_identificador) as e
WHERE d.codigo_unico = e.codigo_unico;

UPDATE calculos.luminarias_octubre2024 AS d SET
latitud_new = null,
longitud_new = null,
zona_new = null,
geom_new = null,
geom_line = null,
distancia = null,
direccion_new = null,
geocodificado = 'NO'
FROM
(SELECT * FROM calculos.luminarias_octubre2024 
WHERE 
direccion_nor ILIKE '%vernet' 
and direccion_nor ILIKE '%plaza%'
and left("descripcion",3) = 'COL'
ORDER BY id_identificador) as e
WHERE d.id_identificador = e.id_identificador;


DO
$do$
BEGIN 
   FOR i IN 1..(SELECT COUNT(*) FROM calculos.luminarias_octubre2024 WHERE direccion_nor ILIKE '%vernet' and direccion_nor ILIKE '%plaza%' and left("descripcion",3) = 'COL') LOOP
			WITH 
			coordenadas_incorrectas as 
			(SELECT * FROM calculos.luminarias_octubre2024 
			WHERE 
			direccion_nor ILIKE '%vernet' and geom_new is null and direccion_nor ILIKE '%plaza%'
			and left("descripcion",3) = 'COL'
			ORDER BY id_identificador), 
			coordenadas_correctas as 
			(SELECT a.* FROM 
			calculos.luminarias_octubre2024 AS a,
			base.plazas AS b
			WHERE ST_INTERSECTS(a.geom,b.geom) and b.nombre = 'PLAZA VERNET'
			AND descripcion = 'luminaria '
			ORDER BY a.id_identificador)
			UPDATE calculos.luminarias_octubre2024 SET
			latitud_new = 
			(SELECT 
			(ARRAY_AGG(latitud))[1]
			FROM coordenadas_correctas where activo_eliminar = 0),
			longitud_new = (SELECT 
			(ARRAY_AGG(longitud))[1]
			FROM coordenadas_correctas where activo_eliminar = 0),
			direccion_new = (SELECT 
			(ARRAY_AGG(direccion))[1]
			FROM coordenadas_correctas where activo_eliminar = 0),
			geocodificado = 'RELEVAMIENTO PLAZAS'

			WHERE 
			id_identificador = (SELECT 
			(ARRAY_AGG(id_identificador))[1] as id_identificador
			FROM coordenadas_incorrectas where geom_new is null ORDER BY id_identificador);

			WITH 
			coordenadas_incorrectas as 
			(SELECT * FROM calculos.luminarias_octubre2024 
			WHERE 
			direccion_nor ILIKE '%vernet' and geom_new is null and direccion_nor ILIKE '%plaza%'
			and left("descripcion",3) = 'COL'
			ORDER BY id_identificador), 
			coordenadas_correctas as 
			(SELECT a.* FROM 
			calculos.luminarias_octubre2024 AS a,
			base.plazas AS b
			WHERE ST_INTERSECTS(a.geom,b.geom) and b.nombre = 'PLAZA VERNET'
			AND descripcion = 'luminaria '
			ORDER BY a.id_identificador)
			UPDATE calculos.luminarias_octubre2024 SET
			codigo_unico = (SELECT (ARRAY_AGG(id_identificador))[1] as id_identificador
			FROM coordenadas_incorrectas where geom_new is null
			ORDER BY id_identificador),
			activo_eliminar = 1
			WHERE 
			id_identificador = (SELECT 
			(ARRAY_AGG(id_identificador))[1] as id_identificador
			FROM coordenadas_correctas where activo_eliminar = 0 ORDER BY id_identificador);

			WITH 
			coordenadas_incorrectas as 
			(SELECT * FROM calculos.luminarias_octubre2024 
			WHERE 
			direccion_nor ILIKE '%vernet' and geom_new is null and direccion_nor ILIKE '%plaza%'
			and left("descripcion",3) = 'COL'
			ORDER BY id_identificador), 
			coordenadas_correctas as 
			(SELECT a.* FROM 
			calculos.luminarias_octubre2024 AS a,
			base.plazas AS b
			WHERE ST_INTERSECTS(a.geom,b.geom) and b.nombre = 'PLAZA VERNET'
			AND descripcion = 'luminaria '
			ORDER BY a.id_identificador)
			UPDATE calculos.luminarias_octubre2024 SET
			geom_new = ST_TRANSFORM(ST_SETSRID(ST_MAKEPOINT((SELECT 
			(ARRAY_AGG(longitud))[1]
			FROM coordenadas_correctas where geocodificado = 'NO')::double precision,(SELECT 
			(ARRAY_AGG(latitud))[1]																					 
			FROM coordenadas_correctas where geocodificado = 'NO')::double precision),4326),32721)
			WHERE 
			id_identificador = (SELECT 
			(ARRAY_AGG(id_identificador))[1] as id_identificador
			FROM coordenadas_incorrectas where geom_new is null ORDER BY id_identificador);
			
			WITH 
			coordenadas_incorrectas as 
			(SELECT * FROM calculos.luminarias_octubre2024 
			WHERE 
			direccion_nor ILIKE '%rubio' and geom_new is null and direccion_nor ILIKE '%plaza%'
			and left("descripcion",3) = 'COL'
			ORDER BY id_identificador), 
			coordenadas_correctas as 
			(SELECT a.* FROM 
			calculos.luminarias_octubre2024 AS a,
			base.plazas AS b
			WHERE ST_INTERSECTS(a.geom,b.geom) and b.nombre = 'PLAZA VERNET'
			AND descripcion = 'luminaria '
			ORDER BY a.id_identificador)
			UPDATE calculos.luminarias_octubre2024 SET
			geocodificado = 'A ELIMINAR'
			WHERE 
			id_identificador = (SELECT 
			(ARRAY_AGG(id_identificador))[1] as id_identificador
			FROM coordenadas_correctas where geocodificado = 'NO' ORDER BY id_identificador);
			
   END LOOP;
END
$do$;


---PLAZA GONZALEZ SOLAR

(SELECT * FROM calculos.luminarias_octubre2024 
WHERE 
direccion_nor ILIKE '%solar%' 
and direccion_nor ILIKE '%plaza%'
--and left("descripcion",3) = 'COL'
ORDER BY id_identificador);

(SELECT a.* FROM 
calculos.luminarias_octubre2024 AS a,
base.plazas AS b
WHERE ST_INTERSECTS(a.geom,b.geom) and b.nombre = 'PLAZA GONZALEZ SOLAR'
--AND descripcion = 'luminaria '
ORDER BY a.id_identificador);

UPDATE calculos.luminarias_octubre2024 AS d SET
codigo_unico = null,
activo_eliminar = 0,
geocodificado = 'NO'
FROM
(SELECT a.* FROM 
calculos.luminarias_octubre2024 AS a,
base.plazas AS b
WHERE ST_INTERSECTS(a.geom,b.geom) and b.nombre = 'PLAZA GONZALEZ SOLAR'
--AND descripcion = 'luminaria '
ORDER BY a.id_identificador) as e
WHERE d.codigo_unico = e.codigo_unico;

UPDATE calculos.luminarias_octubre2024 AS d SET
latitud_new = null,
longitud_new = null,
zona_new = null,
geom_new = null,
geom_line = null,
distancia = null,
direccion_new = null,
geocodificado = 'NO'
FROM
(SELECT * FROM calculos.luminarias_octubre2024 
WHERE 
direccion_nor ILIKE '%solar%' 
and direccion_nor ILIKE '%plaza%'
--and left("descripcion",3) = 'COL'
ORDER BY id_identificador) as e
WHERE d.id_identificador = e.id_identificador;


DO
$do$
BEGIN 
   FOR i IN 1..(SELECT COUNT(*) FROM calculos.luminarias_octubre2024 WHERE direccion_nor ILIKE '%solar%' and direccion_nor ILIKE '%plaza%') LOOP
			WITH 
			coordenadas_incorrectas as 
			(SELECT * FROM calculos.luminarias_octubre2024 
			WHERE 
			direccion_nor ILIKE '%solar%' and geom_new is null and direccion_nor ILIKE '%plaza%'
			--and left("descripcion",3) = 'COL'
			ORDER BY id_identificador), 
			coordenadas_correctas as 
			(SELECT a.* FROM 
			calculos.luminarias_octubre2024 AS a,
			base.plazas AS b
			WHERE ST_INTERSECTS(a.geom,b.geom) and b.nombre = 'PLAZA GONZALEZ SOLAR'
			--AND descripcion = 'luminaria '
			ORDER BY a.id_identificador)
			UPDATE calculos.luminarias_octubre2024 SET
			latitud_new = 
			(SELECT 
			(ARRAY_AGG(latitud))[1]
			FROM coordenadas_correctas where activo_eliminar = 0),
			longitud_new = (SELECT 
			(ARRAY_AGG(longitud))[1]
			FROM coordenadas_correctas where activo_eliminar = 0),
			direccion_new = (SELECT 
			(ARRAY_AGG(direccion))[1]
			FROM coordenadas_correctas where activo_eliminar = 0),
			geocodificado = 'RELEVAMIENTO PLAZAS'

			WHERE 
			id_identificador = (SELECT 
			(ARRAY_AGG(id_identificador))[1] as id_identificador
			FROM coordenadas_incorrectas where geom_new is null ORDER BY id_identificador);

			WITH 
			coordenadas_incorrectas as 
			(SELECT * FROM calculos.luminarias_octubre2024 
			WHERE 
			direccion_nor ILIKE '%solar%' and geom_new is null and direccion_nor ILIKE '%plaza%'
			--and left("descripcion",3) = 'COL'
			ORDER BY id_identificador), 
			coordenadas_correctas as 
			(SELECT a.* FROM 
			calculos.luminarias_octubre2024 AS a,
			base.plazas AS b
			WHERE ST_INTERSECTS(a.geom,b.geom) and b.nombre = 'PLAZA GONZALEZ SOLAR'
			--AND descripcion = 'luminaria '
			ORDER BY a.id_identificador)
			UPDATE calculos.luminarias_octubre2024 SET
			codigo_unico = (SELECT (ARRAY_AGG(id_identificador))[1] as id_identificador
			FROM coordenadas_incorrectas where geom_new is null
			ORDER BY id_identificador),
			activo_eliminar = 1
			WHERE 
			id_identificador = (SELECT 
			(ARRAY_AGG(id_identificador))[1] as id_identificador
			FROM coordenadas_correctas where activo_eliminar = 0 ORDER BY id_identificador);

			WITH 
			coordenadas_incorrectas as 
			(SELECT * FROM calculos.luminarias_octubre2024 
			WHERE 
			direccion_nor ILIKE '%solar%' and geom_new is null and direccion_nor ILIKE '%plaza%'
			--and left("descripcion",3) = 'COL'
			ORDER BY id_identificador), 
			coordenadas_correctas as 
			(SELECT a.* FROM 
			calculos.luminarias_octubre2024 AS a,
			base.plazas AS b
			WHERE ST_INTERSECTS(a.geom,b.geom) and b.nombre = 'PLAZA GONZALEZ SOLAR'
			--AND descripcion = 'luminaria '
			ORDER BY a.id_identificador)
			UPDATE calculos.luminarias_octubre2024 SET
			geom_new = ST_TRANSFORM(ST_SETSRID(ST_MAKEPOINT((SELECT 
			(ARRAY_AGG(longitud))[1]
			FROM coordenadas_correctas where geocodificado = 'NO')::double precision,(SELECT 
			(ARRAY_AGG(latitud))[1]																					 
			FROM coordenadas_correctas where geocodificado = 'NO')::double precision),4326),32721)
			WHERE 
			id_identificador = (SELECT 
			(ARRAY_AGG(id_identificador))[1] as id_identificador
			FROM coordenadas_incorrectas where geom_new is null ORDER BY id_identificador);
			
			WITH 
			coordenadas_incorrectas as 
			(SELECT * FROM calculos.luminarias_octubre2024 
			WHERE 
			direccion_nor ILIKE '%rubio' and geom_new is null and direccion_nor ILIKE '%plaza%'
			--and left("descripcion",3) = 'COL'
			ORDER BY id_identificador), 
			coordenadas_correctas as 
			(SELECT a.* FROM 
			calculos.luminarias_octubre2024 AS a,
			base.plazas AS b
			WHERE ST_INTERSECTS(a.geom,b.geom) and b.nombre = 'PLAZA GONZALEZ SOLAR'
			--AND descripcion = 'luminaria '
			ORDER BY a.id_identificador)
			UPDATE calculos.luminarias_octubre2024 SET
			geocodificado = 'A ELIMINAR'
			WHERE 
			id_identificador = (SELECT 
			(ARRAY_AGG(id_identificador))[1] as id_identificador
			FROM coordenadas_correctas where geocodificado = 'NO' ORDER BY id_identificador);
			
   END LOOP;
END
$do$;


---PLAZA DE LAS AMERICAS

(SELECT * FROM calculos.luminarias_octubre2024 
WHERE 
direccion_nor ILIKE '%americas%' 
and direccion_nor ILIKE '%plaza%'
--and left("descripcion",3) = 'COL'
ORDER BY id_identificador);

(SELECT a.* FROM 
calculos.luminarias_octubre2024 AS a,
base.plazas AS b
WHERE ST_INTERSECTS(a.geom,b.geom) and b.nombre = 'PLAZA DE LAS AMERICAS'
--AND descripcion = 'luminaria '
ORDER BY a.id_identificador);

UPDATE calculos.luminarias_octubre2024 AS d SET
codigo_unico = null,
activo_eliminar = 0,
geocodificado = 'NO'
FROM
(SELECT a.* FROM 
calculos.luminarias_octubre2024 AS a,
base.plazas AS b
WHERE ST_INTERSECTS(a.geom,b.geom) and b.nombre = 'PLAZA DE LAS AMERICAS'
--AND descripcion = 'luminaria '
ORDER BY a.id_identificador) as e
WHERE d.codigo_unico = e.codigo_unico;

UPDATE calculos.luminarias_octubre2024 AS d SET
latitud_new = null,
longitud_new = null,
zona_new = null,
geom_new = null,
geom_line = null,
distancia = null,
direccion_new = null,
geocodificado = 'NO'
FROM
(SELECT * FROM calculos.luminarias_octubre2024 
WHERE 
direccion_nor ILIKE '%americas%' 
and direccion_nor ILIKE '%plaza%'
--and left("descripcion",3) = 'COL'
ORDER BY id_identificador) as e
WHERE d.id_identificador = e.id_identificador;


DO
$do$
BEGIN 
   FOR i IN 1..(SELECT COUNT(*) FROM calculos.luminarias_octubre2024 WHERE direccion_nor ILIKE '%americas%' and direccion_nor ILIKE '%plaza%') LOOP
			WITH 
			coordenadas_incorrectas as 
			(SELECT * FROM calculos.luminarias_octubre2024 
			WHERE 
			direccion_nor ILIKE '%americas%' and geom_new is null and direccion_nor ILIKE '%plaza%'
			--and left("descripcion",3) = 'COL'
			ORDER BY id_identificador), 
			coordenadas_correctas as 
			(SELECT a.* FROM 
			calculos.luminarias_octubre2024 AS a,
			base.plazas AS b
			WHERE ST_INTERSECTS(a.geom,b.geom) and b.nombre = 'PLAZA DE LAS AMERICAS'
			--AND descripcion = 'luminaria '
			ORDER BY a.id_identificador)
			UPDATE calculos.luminarias_octubre2024 SET
			latitud_new = 
			(SELECT 
			(ARRAY_AGG(latitud))[1]
			FROM coordenadas_correctas where activo_eliminar = 0),
			longitud_new = (SELECT 
			(ARRAY_AGG(longitud))[1]
			FROM coordenadas_correctas where activo_eliminar = 0),
			direccion_new = (SELECT 
			(ARRAY_AGG(direccion))[1]
			FROM coordenadas_correctas where activo_eliminar = 0),
			geocodificado = 'RELEVAMIENTO PLAZAS'

			WHERE 
			id_identificador = (SELECT 
			(ARRAY_AGG(id_identificador))[1] as id_identificador
			FROM coordenadas_incorrectas where geom_new is null ORDER BY id_identificador);

			WITH 
			coordenadas_incorrectas as 
			(SELECT * FROM calculos.luminarias_octubre2024 
			WHERE 
			direccion_nor ILIKE '%americas%' and geom_new is null and direccion_nor ILIKE '%plaza%'
			--and left("descripcion",3) = 'COL'
			ORDER BY id_identificador), 
			coordenadas_correctas as 
			(SELECT a.* FROM 
			calculos.luminarias_octubre2024 AS a,
			base.plazas AS b
			WHERE ST_INTERSECTS(a.geom,b.geom) and b.nombre = 'PLAZA DE LAS AMERICAS'
			--AND descripcion = 'luminaria '
			ORDER BY a.id_identificador)
			UPDATE calculos.luminarias_octubre2024 SET
			codigo_unico = (SELECT (ARRAY_AGG(id_identificador))[1] as id_identificador
			FROM coordenadas_incorrectas where geom_new is null
			ORDER BY id_identificador),
			activo_eliminar = 1
			WHERE 
			id_identificador = (SELECT 
			(ARRAY_AGG(id_identificador))[1] as id_identificador
			FROM coordenadas_correctas where activo_eliminar = 0 ORDER BY id_identificador);

			WITH 
			coordenadas_incorrectas as 
			(SELECT * FROM calculos.luminarias_octubre2024 
			WHERE 
			direccion_nor ILIKE '%americas%' and geom_new is null and direccion_nor ILIKE '%plaza%'
			--and left("descripcion",3) = 'COL'
			ORDER BY id_identificador), 
			coordenadas_correctas as 
			(SELECT a.* FROM 
			calculos.luminarias_octubre2024 AS a,
			base.plazas AS b
			WHERE ST_INTERSECTS(a.geom,b.geom) and b.nombre = 'PLAZA DE LAS AMERICAS'
			--AND descripcion = 'luminaria '
			ORDER BY a.id_identificador)
			UPDATE calculos.luminarias_octubre2024 SET
			geom_new = ST_TRANSFORM(ST_SETSRID(ST_MAKEPOINT((SELECT 
			(ARRAY_AGG(longitud))[1]
			FROM coordenadas_correctas where geocodificado = 'NO')::double precision,(SELECT 
			(ARRAY_AGG(latitud))[1]																					 
			FROM coordenadas_correctas where geocodificado = 'NO')::double precision),4326),32721)
			WHERE 
			id_identificador = (SELECT 
			(ARRAY_AGG(id_identificador))[1] as id_identificador
			FROM coordenadas_incorrectas where geom_new is null ORDER BY id_identificador);
			
			WITH 
			coordenadas_incorrectas as 
			(SELECT * FROM calculos.luminarias_octubre2024 
			WHERE 
			direccion_nor ILIKE '%rubio' and geom_new is null and direccion_nor ILIKE '%plaza%'
			--and left("descripcion",3) = 'COL'
			ORDER BY id_identificador), 
			coordenadas_correctas as 
			(SELECT a.* FROM 
			calculos.luminarias_octubre2024 AS a,
			base.plazas AS b
			WHERE ST_INTERSECTS(a.geom,b.geom) and b.nombre = 'PLAZA DE LAS AMERICAS'
			--AND descripcion = 'luminaria '
			ORDER BY a.id_identificador)
			UPDATE calculos.luminarias_octubre2024 SET
			geocodificado = 'A ELIMINAR'
			WHERE 
			id_identificador = (SELECT 
			(ARRAY_AGG(id_identificador))[1] as id_identificador
			FROM coordenadas_correctas where geocodificado = 'NO' ORDER BY id_identificador);
			
   END LOOP;
END
$do$;


---PLAZA CHACABUCO

(SELECT * FROM calculos.luminarias_octubre2024 
WHERE 
direccion_nor ILIKE '%chacabuco%' 
and direccion_nor ILIKE '%plaza%'
--and left("descripcion",3) = 'COL'
ORDER BY id_identificador);

(SELECT a.* FROM 
calculos.luminarias_octubre2024 AS a,
base.plazas AS b
WHERE ST_INTERSECTS(a.geom,b.geom) and b.nombre = 'PLAZA CHACABUCO' 
AND descripcion ILIKE '%luminaria%'
ORDER BY a.id_identificador);

UPDATE calculos.luminarias_octubre2024 AS d SET
codigo_unico = null,
activo_eliminar = 0,
geocodificado = 'NO'
FROM
(SELECT a.* FROM 
calculos.luminarias_octubre2024 AS a,
base.plazas AS b
WHERE ST_INTERSECTS(a.geom,b.geom) and b.nombre = 'PLAZA CHACABUCO' 
AND descripcion ILIKE '%luminaria%'
ORDER BY a.id_identificador) as e
WHERE d.codigo_unico = e.codigo_unico;

UPDATE calculos.luminarias_octubre2024 AS d SET
latitud_new = null,
longitud_new = null,
zona_new = null,
geom_new = null,
geom_line = null,
distancia = null,
direccion_new = null,
geocodificado = 'NO'
FROM
(SELECT * FROM calculos.luminarias_octubre2024 
WHERE 
direccion_nor ILIKE '%chacabuco%' 
and direccion_nor ILIKE '%plaza%'
--and left("descripcion",3) = 'COL'
ORDER BY id_identificador) as e
WHERE d.id_identificador = e.id_identificador;


DO
$do$
BEGIN 
   FOR i IN 1..(SELECT COUNT(*) FROM calculos.luminarias_octubre2024 WHERE direccion_nor ILIKE '%chacabuco%' and direccion_nor ILIKE '%plaza%') LOOP
			WITH 
			coordenadas_incorrectas as 
			(SELECT * FROM calculos.luminarias_octubre2024 
			WHERE 
			direccion_nor ILIKE '%chacabuco%' 
			and direccion_nor ILIKE '%plaza%'
			--and left("descripcion",3) = 'COL'
			ORDER BY id_identificador), 
			coordenadas_correctas as 
			(SELECT a.* FROM 
			calculos.luminarias_octubre2024 AS a,
			base.plazas AS b
			WHERE ST_INTERSECTS(a.geom,b.geom) and b.nombre = 'PLAZA CHACABUCO' 
			AND descripcion ILIKE '%luminaria%'
			ORDER BY a.id_identificador)
			UPDATE calculos.luminarias_octubre2024 SET
			latitud_new = 
			(SELECT 
			(ARRAY_AGG(latitud))[1]
			FROM coordenadas_correctas where activo_eliminar = 0),
			longitud_new = (SELECT 
			(ARRAY_AGG(longitud))[1]
			FROM coordenadas_correctas where activo_eliminar = 0),
			direccion_new = (SELECT 
			(ARRAY_AGG(direccion))[1]
			FROM coordenadas_correctas where activo_eliminar = 0),
			geocodificado = 'RELEVAMIENTO PLAZAS'

			WHERE 
			id_identificador = (SELECT 
			(ARRAY_AGG(id_identificador))[1] as id_identificador
			FROM coordenadas_incorrectas where geom_new is null ORDER BY id_identificador);

			WITH 
			coordenadas_incorrectas as 
			(SELECT * FROM calculos.luminarias_octubre2024 
			WHERE 
			direccion_nor ILIKE '%chacabuco%' 
			and direccion_nor ILIKE '%plaza%'
			--and left("descripcion",3) = 'COL'
			ORDER BY id_identificador), 
			coordenadas_correctas as 
			(SELECT a.* FROM 
			calculos.luminarias_octubre2024 AS a,
			base.plazas AS b
			WHERE ST_INTERSECTS(a.geom,b.geom) and b.nombre = 'PLAZA CHACABUCO' 
			AND descripcion ILIKE '%luminaria%'
			ORDER BY a.id_identificador)
			UPDATE calculos.luminarias_octubre2024 SET
			codigo_unico = (SELECT (ARRAY_AGG(id_identificador))[1] as id_identificador
			FROM coordenadas_incorrectas where geom_new is null
			ORDER BY id_identificador),
			activo_eliminar = 1
			WHERE 
			id_identificador = (SELECT 
			(ARRAY_AGG(id_identificador))[1] as id_identificador
			FROM coordenadas_correctas where activo_eliminar = 0 ORDER BY id_identificador);

			WITH 
			coordenadas_incorrectas as 
			(SELECT * FROM calculos.luminarias_octubre2024 
			WHERE 
			direccion_nor ILIKE '%chacabuco%' 
			and direccion_nor ILIKE '%plaza%'
			--and left("descripcion",3) = 'COL'
			ORDER BY id_identificador), 
			coordenadas_correctas as 
			(SELECT a.* FROM 
			calculos.luminarias_octubre2024 AS a,
			base.plazas AS b
			WHERE ST_INTERSECTS(a.geom,b.geom) and b.nombre = 'PLAZA CHACABUCO' 
			AND descripcion ILIKE '%luminaria%'
			ORDER BY a.id_identificador)
			UPDATE calculos.luminarias_octubre2024 SET
			geom_new = ST_TRANSFORM(ST_SETSRID(ST_MAKEPOINT((SELECT 
			(ARRAY_AGG(longitud))[1]
			FROM coordenadas_correctas where geocodificado = 'NO')::double precision,(SELECT 
			(ARRAY_AGG(latitud))[1]																					 
			FROM coordenadas_correctas where geocodificado = 'NO')::double precision),4326),32721)
			WHERE 
			id_identificador = (SELECT 
			(ARRAY_AGG(id_identificador))[1] as id_identificador
			FROM coordenadas_incorrectas where geom_new is null ORDER BY id_identificador);
			
			WITH 
			coordenadas_incorrectas as 
			(SELECT * FROM calculos.luminarias_octubre2024 
			WHERE 
			direccion_nor ILIKE '%chacabuco%' 
			and direccion_nor ILIKE '%plaza%'
			--and left("descripcion",3) = 'COL'
			ORDER BY id_identificador), 
			coordenadas_correctas as 
			(SELECT a.* FROM 
			calculos.luminarias_octubre2024 AS a,
			base.plazas AS b
			WHERE ST_INTERSECTS(a.geom,b.geom) and b.nombre = 'PLAZA CHACABUCO' 
			AND descripcion ILIKE '%luminaria%'
			ORDER BY a.id_identificador)
			UPDATE calculos.luminarias_octubre2024 SET
			geocodificado = 'A ELIMINAR'
			WHERE 
			id_identificador = (SELECT 
			(ARRAY_AGG(id_identificador))[1] as id_identificador
			FROM coordenadas_correctas where geocodificado = 'NO' ORDER BY id_identificador);
			
   END LOOP;
END
$do$;


---PLAZA GENERAL ROCA

(SELECT * FROM calculos.luminarias_octubre2024 
WHERE 
direccion_nor ILIKE '%roca%' 
and direccion_nor ILIKE '%plaza%'
and left("descripcion",3) = 'COL'
ORDER BY id_identificador);

(SELECT a.* FROM 
calculos.luminarias_octubre2024 AS a,
base.plazas AS b
WHERE ST_INTERSECTS(a.geom,b.geom) and b.nombre = 'PLAZA GENERAL ROCA' 
AND descripcion ILIKE '%luminaria%'
ORDER BY a.id_identificador);

UPDATE calculos.luminarias_octubre2024 AS d SET
codigo_unico = null,
activo_eliminar = 0,
geocodificado = 'NO'
FROM
(SELECT a.* FROM 
calculos.luminarias_octubre2024 AS a,
base.plazas AS b
WHERE ST_INTERSECTS(a.geom,b.geom) and b.nombre = 'PLAZA GENERAL ROCA' 
AND descripcion ILIKE '%luminaria%'
ORDER BY a.id_identificador) as e
WHERE d.codigo_unico = e.codigo_unico;

UPDATE calculos.luminarias_octubre2024 AS d SET
latitud_new = null,
longitud_new = null,
zona_new = null,
geom_new = null,
geom_line = null,
distancia = null,
direccion_new = null,
geocodificado = 'NO'
FROM
(SELECT * FROM calculos.luminarias_octubre2024 
WHERE 
direccion_nor ILIKE '%roca%' 
and direccion_nor ILIKE '%plaza%'
and left("descripcion",3) = 'COL'
ORDER BY id_identificador) as e
WHERE d.id_identificador = e.id_identificador;


DO
$do$
BEGIN 
   FOR i IN 1..(SELECT COUNT(*) FROM calculos.luminarias_octubre2024 WHERE direccion_nor ILIKE '%roca%' and direccion_nor ILIKE '%plaza%' and left("descripcion",3) = 'COL') LOOP
			WITH 
			coordenadas_incorrectas as 
			(SELECT * FROM calculos.luminarias_octubre2024 
			WHERE 
			direccion_nor ILIKE '%roca%' 
			and direccion_nor ILIKE '%plaza%'
			and left("descripcion",3) = 'COL'
			ORDER BY id_identificador), 
			coordenadas_correctas as 
			(SELECT a.* FROM 
			calculos.luminarias_octubre2024 AS a,
			base.plazas AS b
			WHERE ST_INTERSECTS(a.geom,b.geom) and b.nombre = 'PLAZA GENERAL ROCA' 
			AND descripcion ILIKE '%luminaria%'
			ORDER BY a.id_identificador)
			UPDATE calculos.luminarias_octubre2024 SET
			latitud_new = 
			(SELECT 
			(ARRAY_AGG(latitud))[1]
			FROM coordenadas_correctas where activo_eliminar = 0),
			longitud_new = (SELECT 
			(ARRAY_AGG(longitud))[1]
			FROM coordenadas_correctas where activo_eliminar = 0),
			direccion_new = (SELECT 
			(ARRAY_AGG(direccion))[1]
			FROM coordenadas_correctas where activo_eliminar = 0),
			geocodificado = 'RELEVAMIENTO PLAZAS'

			WHERE 
			id_identificador = (SELECT 
			(ARRAY_AGG(id_identificador))[1] as id_identificador
			FROM coordenadas_incorrectas where geom_new is null ORDER BY id_identificador);

			WITH 
			coordenadas_incorrectas as 
			(SELECT * FROM calculos.luminarias_octubre2024 
			WHERE 
			direccion_nor ILIKE '%roca%' 
			and direccion_nor ILIKE '%plaza%'
			and left("descripcion",3) = 'COL'
			ORDER BY id_identificador), 
			coordenadas_correctas as 
			(SELECT a.* FROM 
			calculos.luminarias_octubre2024 AS a,
			base.plazas AS b
			WHERE ST_INTERSECTS(a.geom,b.geom) and b.nombre = 'PLAZA GENERAL ROCA' 
			AND descripcion ILIKE '%luminaria%'
			ORDER BY a.id_identificador)
			UPDATE calculos.luminarias_octubre2024 SET
			codigo_unico = (SELECT (ARRAY_AGG(id_identificador))[1] as id_identificador
			FROM coordenadas_incorrectas where geom_new is null
			ORDER BY id_identificador),
			activo_eliminar = 1
			WHERE 
			id_identificador = (SELECT 
			(ARRAY_AGG(id_identificador))[1] as id_identificador
			FROM coordenadas_correctas where activo_eliminar = 0 ORDER BY id_identificador);

			WITH 
			coordenadas_incorrectas as 
			(SELECT * FROM calculos.luminarias_octubre2024 
			WHERE 
			direccion_nor ILIKE '%roca%' 
			and direccion_nor ILIKE '%plaza%'
			and left("descripcion",3) = 'COL'
			ORDER BY id_identificador), 
			coordenadas_correctas as 
			(SELECT a.* FROM 
			calculos.luminarias_octubre2024 AS a,
			base.plazas AS b
			WHERE ST_INTERSECTS(a.geom,b.geom) and b.nombre = 'PLAZA GENERAL ROCA' 
			AND descripcion ILIKE '%luminaria%'
			ORDER BY a.id_identificador)
			UPDATE calculos.luminarias_octubre2024 SET
			geom_new = ST_TRANSFORM(ST_SETSRID(ST_MAKEPOINT((SELECT 
			(ARRAY_AGG(longitud))[1]
			FROM coordenadas_correctas where geocodificado = 'NO')::double precision,(SELECT 
			(ARRAY_AGG(latitud))[1]																					 
			FROM coordenadas_correctas where geocodificado = 'NO')::double precision),4326),32721)
			WHERE 
			id_identificador = (SELECT 
			(ARRAY_AGG(id_identificador))[1] as id_identificador
			FROM coordenadas_incorrectas where geom_new is null ORDER BY id_identificador);
			
			WITH 
			coordenadas_incorrectas as 
			(SELECT * FROM calculos.luminarias_octubre2024 
			WHERE 
			direccion_nor ILIKE '%roca%' 
			and direccion_nor ILIKE '%plaza%'
			and left("descripcion",3) = 'COL'
			ORDER BY id_identificador), 
			coordenadas_correctas as 
			(SELECT a.* FROM 
			calculos.luminarias_octubre2024 AS a,
			base.plazas AS b
			WHERE ST_INTERSECTS(a.geom,b.geom) and b.nombre = 'PLAZA GENERAL ROCA' 
			AND descripcion ILIKE '%luminaria%'
			ORDER BY a.id_identificador)
			UPDATE calculos.luminarias_octubre2024 SET
			geocodificado = 'A ELIMINAR'
			WHERE 
			id_identificador = (SELECT 
			(ARRAY_AGG(id_identificador))[1] as id_identificador
			FROM coordenadas_correctas where geocodificado = 'NO' ORDER BY id_identificador);
			
   END LOOP;
END
$do$;


---PLAZA DE LA COMUNIDAD

(SELECT * FROM calculos.luminarias_octubre2024 
WHERE 
direccion_nor ILIKE '%comunidad%' 
and direccion_nor ILIKE '%plaza%'
and left("descripcion",3) = 'COL'
ORDER BY id_identificador);

(SELECT a.* FROM 
calculos.luminarias_octubre2024 AS a,
base.plazas AS b
WHERE ST_INTERSECTS(a.geom,b.geom) and b.nombre = 'PLAZA DE LA COMUNIDAD' 
AND descripcion ILIKE '%luminaria%'
ORDER BY a.id_identificador);

UPDATE calculos.luminarias_octubre2024 AS d SET
codigo_unico = null,
activo_eliminar = 0,
geocodificado = 'NO'
FROM
(SELECT a.* FROM 
calculos.luminarias_octubre2024 AS a,
base.plazas AS b
WHERE ST_INTERSECTS(a.geom,b.geom) and b.nombre = 'PLAZA DE LA COMUNIDAD' 
AND descripcion ILIKE '%luminaria%'
ORDER BY a.id_identificador) as e
WHERE d.codigo_unico = e.codigo_unico;

UPDATE calculos.luminarias_octubre2024 AS d SET
latitud_new = null,
longitud_new = null,
zona_new = null,
geom_new = null,
geom_line = null,
distancia = null,
direccion_new = null,
geocodificado = 'NO'
FROM
(SELECT * FROM calculos.luminarias_octubre2024 
WHERE 
direccion_nor ILIKE '%comunidad%' 
and direccion_nor ILIKE '%plaza%'
and left("descripcion",3) = 'COL'
ORDER BY id_identificador) as e
WHERE d.id_identificador = e.id_identificador;


DO
$do$
BEGIN 
   FOR i IN 1..(SELECT COUNT(*) FROM calculos.luminarias_octubre2024 WHERE direccion_nor ILIKE '%comunidad%' and direccion_nor ILIKE '%plaza%' and left("descripcion",3) = 'COL') LOOP
			WITH 
			coordenadas_incorrectas as 
			(SELECT * FROM calculos.luminarias_octubre2024 
			WHERE 
			direccion_nor ILIKE '%comunidad%' 
			and direccion_nor ILIKE '%plaza%'
			and left("descripcion",3) = 'COL'
			ORDER BY id_identificador), 
			coordenadas_correctas as 
			(SELECT a.* FROM 
			calculos.luminarias_octubre2024 AS a,
			base.plazas AS b
			WHERE ST_INTERSECTS(a.geom,b.geom) and b.nombre = 'PLAZA DE LA COMUNIDAD' 
			AND descripcion ILIKE '%luminaria%'
			ORDER BY a.id_identificador)
			UPDATE calculos.luminarias_octubre2024 SET
			latitud_new = 
			(SELECT 
			(ARRAY_AGG(latitud))[1]
			FROM coordenadas_correctas where activo_eliminar = 0),
			longitud_new = (SELECT 
			(ARRAY_AGG(longitud))[1]
			FROM coordenadas_correctas where activo_eliminar = 0),
			direccion_new = (SELECT 
			(ARRAY_AGG(direccion))[1]
			FROM coordenadas_correctas where activo_eliminar = 0),
			geocodificado = 'RELEVAMIENTO PLAZAS'

			WHERE 
			id_identificador = (SELECT 
			(ARRAY_AGG(id_identificador))[1] as id_identificador
			FROM coordenadas_incorrectas where geom_new is null ORDER BY id_identificador);

			WITH 
			coordenadas_incorrectas as 
			(SELECT * FROM calculos.luminarias_octubre2024 
			WHERE 
			direccion_nor ILIKE '%comunidad%' 
			and direccion_nor ILIKE '%plaza%'
			and left("descripcion",3) = 'COL'
			ORDER BY id_identificador), 
			coordenadas_correctas as 
			(SELECT a.* FROM 
			calculos.luminarias_octubre2024 AS a,
			base.plazas AS b
			WHERE ST_INTERSECTS(a.geom,b.geom) and b.nombre = 'PLAZA DE LA COMUNIDAD' 
			AND descripcion ILIKE '%luminaria%'
			ORDER BY a.id_identificador)
			UPDATE calculos.luminarias_octubre2024 SET
			codigo_unico = (SELECT (ARRAY_AGG(id_identificador))[1] as id_identificador
			FROM coordenadas_incorrectas where geom_new is null
			ORDER BY id_identificador),
			activo_eliminar = 1
			WHERE 
			id_identificador = (SELECT 
			(ARRAY_AGG(id_identificador))[1] as id_identificador
			FROM coordenadas_correctas where activo_eliminar = 0 ORDER BY id_identificador);

			WITH 
			coordenadas_incorrectas as 
			(SELECT * FROM calculos.luminarias_octubre2024 
			WHERE 
			direccion_nor ILIKE '%comunidad%' 
			and direccion_nor ILIKE '%plaza%'
			and left("descripcion",3) = 'COL'
			ORDER BY id_identificador), 
			coordenadas_correctas as 
			(SELECT a.* FROM 
			calculos.luminarias_octubre2024 AS a,
			base.plazas AS b
			WHERE ST_INTERSECTS(a.geom,b.geom) and b.nombre = 'PLAZA DE LA COMUNIDAD' 
			AND descripcion ILIKE '%luminaria%'
			ORDER BY a.id_identificador)
			UPDATE calculos.luminarias_octubre2024 SET
			geom_new = ST_TRANSFORM(ST_SETSRID(ST_MAKEPOINT((SELECT 
			(ARRAY_AGG(longitud))[1]
			FROM coordenadas_correctas where geocodificado = 'NO')::double precision,(SELECT 
			(ARRAY_AGG(latitud))[1]																					 
			FROM coordenadas_correctas where geocodificado = 'NO')::double precision),4326),32721)
			WHERE 
			id_identificador = (SELECT 
			(ARRAY_AGG(id_identificador))[1] as id_identificador
			FROM coordenadas_incorrectas where geom_new is null ORDER BY id_identificador);
			
			WITH 
			coordenadas_incorrectas as 
			(SELECT * FROM calculos.luminarias_octubre2024 
			WHERE 
			direccion_nor ILIKE '%comunidad%' 
			and direccion_nor ILIKE '%plaza%'
			and left("descripcion",3) = 'COL'
			ORDER BY id_identificador), 
			coordenadas_correctas as 
			(SELECT a.* FROM 
			calculos.luminarias_octubre2024 AS a,
			base.plazas AS b
			WHERE ST_INTERSECTS(a.geom,b.geom) and b.nombre = 'PLAZA DE LA COMUNIDAD' 
			AND descripcion ILIKE '%luminaria%'
			ORDER BY a.id_identificador)
			UPDATE calculos.luminarias_octubre2024 SET
			geocodificado = 'A ELIMINAR'
			WHERE 
			id_identificador = (SELECT 
			(ARRAY_AGG(id_identificador))[1] as id_identificador
			FROM coordenadas_correctas where geocodificado = 'NO' ORDER BY id_identificador);
			
   END LOOP;
END
$do$;

--LUMINARIAS EN PLAZAS RELEVADAS QUE ESTÁN LOCALIZADAS POR GPS PARA RELEVARLE LA DESCRIPCIÓN
UPDATE calculos.luminarias_octubre2024 as a SET
latitud_new = b.latitud,
longitud_new = b.longitud,
geom_new = ST_TRANSFORM(ST_SETSRID(ST_MAKEPOINT( 
(b.longitud)::double precision,(b.latitud)::double precision),4326),32721),
geocodificado = 'ASIGNAR codigo_unico' FROM
(SELECT a.* FROM 
calculos.luminarias_octubre2024 AS a,
base.plazas AS b
WHERE ST_INTERSECTS(a.geom,b.geom) and geom_new is null and codigo_unico is null
ORDER BY a.id_identificador) AS b
WHERE a.id_identificador = b.id_identificador;


UPDATE calculos.luminarias_octubre2024 SET
geom_line = ST_MAKELINE(geom,geom_new),
distancia = ST_DISTANCE(geom,geom_new)
WHERE geom_new  IS NOT NULL;


--ASIGNANDO NUEVO BARRIO EN FUNCION DE NUEVA LOCALIZACION
UPDATE calculos.luminarias_octubre2024 as c SET
barrio_new = d."NOMBRE"  FROM
(SELECT a.id, upper(a."Barrio") as barrio, b."NOMBRE" FROM 
calculos.luminarias_octubre2024 as a,
base.barrios as b
WHERE ST_INTERSECTS(ST_TRANSFORM(a.geom_new,4326),b.geom)) as d
WHERE c.id = d.id;

--ASIGNANDO NUEVA ZONA SI APLICA EN FUNCION DE NUEVA LOCALIZACION
update calculos.luminarias_octubre2024 set 
zona_new = 'AUSOL' where id in (select a.id from 
calculos.luminarias_octubre2024 as a,
base.ausol_poligono as b
where ST_INTERSECTS(ST_TRANSFORM(a.geom,4326),b.geom));

update calculos.luminarias_octubre2024 set 
zona_new = 'MANTELECTRIC' where zona_new is null;

			
			
